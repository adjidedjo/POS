<h1>Laporan Selisih Stock vs Return Display <%= current_user.channel_customer.nama.titleize %></h1>

<table id="sales_rekap_stock" class="display table-striped table-bordered" cellspacing="0" width="100%">
  <thead>
    <tr>
      <th>No SJ</th>
      <th>Kode Barang</th>
      <th>Nama Barang</th>
      <th>Stock</th>
      <th>Retur</th>
      <th>Selisih</th>
    </tr>
  </thead>

  <tbody>
    <% @retur.each do |ins| %>
      <tr>
        <td><%= ins.no_sj %></td>
        <td><%= ins.kode_barang %></td>
        <td><%= ExhibitionStockItem.find_by_kode_barang(ins.kode_barang).nama %></td>
        <% stock = ExhibitionStockItem.where(kode_barang: ins.kode_barang, no_sj: ins.no_sj, checked_in: true, channel_customer_id: current_user.channel_customer.id).sum(:stok_awal)  %>
        <% sales = StoreSalesAndStockHistory.where(kode_barang: ins.kode_barang, channel_customer_id: current_user.channel_customer.id, keterangan: "S").sum(:qty_out)  %>
        <td><%= stock - sales %></td>
        <% retur = StoreSalesAndStockHistory.where(kode_barang: ins.kode_barang, no_sj: ins.no_sj, channel_customer_id: current_user.channel_customer.id, keterangan: "B").sum(:qty_out)  %>
        <td><%= retur %></td>
        <td><%= (stock - sales) - retur %></td>
      </tr>
    <% end %>
  </tbody>
</table>
